---
type: 安全
title: 用户行为分析
date: 2020-03-02
category: security

tags:
- 工作
- 研究
description: 关于用户行为分析（UEBA）的调研分析
---
>对用户行为分析（UEBA）的一些见解认识

* [什么是用户行为分析（UEBA）](#什么是用户行为分析（UEBA）)
   * [UEBA来源和定义](#UEBA来源和定义)
   * [UEBA的市场分析定位](#UEBA的市场分析定位)
* [UEBA可以解决哪些问题](#UEBA可以解决哪些问题)
* [UEBA应用落地的关键事项](#UEBA应用落地的关键事项)
* [UEBA的最佳实践以及相关厂商](#UEBA的最佳实践以及相关厂商)
   * [UEBA和机器学习](#UEBA和机器学习)
* [从整体企业安全谈UEBA](#从整体企业安全谈UEBA)
   * [UEBA如何贯彻这几个层次](#UEBA如何贯彻这几个层次)
   * [两个案例——用UEBA方法论实践去发现异常](#两个案例——用UEBA方法论实践去发现异常)    
* [UBA分析策略](#UBA分析策略)
   * [分析策略](#分析策略)
   * [如何判断正常行为](#如何判断正常行为) 
* [机器学习算法在用户行为检测(UBA)领域的应用](#机器学习算法在用户行为检测(UBA)领域的应用)
* [总结](#总结)
* [参考](#参考)

干货：
1. [员工风险与UEBA - “安全+” 沙龙第十二期](https://mp.weixin.qq.com/s/Y_mAd-IA4rAra1FqfZc8JQ)
2. [总基于AI的UEBA大数据分析 | 安全+沙龙19期结](https://mp.weixin.qq.com/s/nXYNHA8xT5rBCgWjEAO0lg)
3. [UEBA架构设计之路1：UEBA框架](#https://www.secpulse.com/archives/95668.html)
4. [UEBA架构设计之路2：数据接入和准备](#https://www.secpulse.com/archives/96063.html)
5. [UEBA架构设计之路3：复杂事件处理引擎](#https://www.secpulse.com/archives/96049.html)

## 什么是用户行为分析（UEBA）
### UEBA来源和定义
UBA（User Behavior Analytics，用户行为分析）
UEBA（User and Entity Behavior Analytics，用户实体行为分析）
UEBA前身叫UBA（用户行为分析）最早用在网站访问和精准营销方面，通过对相关数据（用户购买、点击、收藏等行为）进行统计、分析，实现用户标签画像，预测用户消费习惯，最终对用户感兴趣商品进行推送，达到精准营销的目的。

UEBA能以极高的准确率命中异常事件，使真正的安全威胁浮出水面，这是用户实体行为分析（UEBA）备受关注的主要原因。用户实体行为分析（UEBA）关联了用户活动和相关实体（用户相关的应用和终端等）信息构建人物角色与群组，进一步定义这些个体与群组的合法和正常行为，把这些人物角色在群体与群体、群体与个体、个体与个体（那些远离合法和正常行为的群体与个体）维度上相互比对分析，将异常用户（失陷账号）和用户异常（非法行为）检测出来，从而达到检测业务欺诈、敏感数据泄露、内部恶意用户、有针对性攻击等高级威胁的目的
### UEBA的市场分析定位
* 2014年，Gartner发布了用户行为分析（UBA）市场界定；
* 2015年，Gartner将用户行为分析(UBA)更名为用户实体行为分析(UEBA)；
* 2016年，用户实体行为分析(UEBA)入选Gartner十大信息安全技术；
* 2017年，用户实体行为分析(UEBA)厂商强势进入2017年度的Gartner SIEM魔力象限；
* 2018年，用户实体行为分析(UEBA)入选Gartner为安全团队建议的十大新项目。

&nbsp;&nbsp;&nbsp;&nbsp;2014年，Gartner发布了用户行为分析(UBA)市场界定，用户行为分析(UBA)技术目标市场聚焦在安全（窃取数据）和诈骗（利用窃取来的信息）上，帮助企业检测内部威胁、有针对性的攻击和金融诈骗。

&nbsp;&nbsp;&nbsp;&nbsp;为使这部分市场快速发展和成熟，Gartner认为有必要把这部分从诈骗检测技术中剥离出来。于是在2015年正式将用户行为分析(UBA)更名为用户实体行为分析(UEBA)。至于加入了实体行为分析，Gartner的解释是实体行为从某种程度上关联了用户行为，关注实体行为分析可以更准确地识别威胁。

&nbsp;&nbsp;&nbsp;&nbsp;准确地说，用户行为分析(UBA)关联了用户活动和相关实体（用户相关的应用和终端等）信息构建人物角色与群组，进一步定义这些个体与群组的合法和正常行为，把这些人物角色在群体与群体、群体与个体、个体与个体（那些远离合法和正常行为的群体与个体）维度上相互比对分析，将异常用户（失陷账号）和用户异常（非法行为）检测出来，从而达到检测业务欺诈、敏感数据泄露、内部恶意用户、有针对性攻击等高级威胁的目的。

## UEBA可以解决哪些问题
传统安全技术都是依赖于规则进行检测，检测引擎里内置了很多已知规则、专家经验和人为设定的阈值，这种技术通常会导致误报率很高、准确率很低的问题，甚至对于一些新型的未知威胁行为根本检测不出来。

用户实体行为分析（UEBA）则是从另外一个视角去发现问题，从单维度检测到多维度分析，从单点检测到长周期分析，从基于规则分析到关联分析、行为建模、异常分析来发现更多更准确的安全威胁。

用户实体行为分析（UEBA）能够弥补传统检测技术、单点安全分析的不足，通过用户实体行为异常分析来检测各种业务与安全风险，具体的应用场景及检测的风险类别详细说明如下：

* 1.金融反欺诈
金融诈骗一般每一个流程环节都由不同的团伙完成，撞库、养号属于金融诈骗前端环节，利用规则分析、关联分析、机器学习算法等手段，对金融用户及相关实体实时进行异常分析，可以有效检测撞库、养号等金融诈骗行为的发生。
* 2.数据泄露检测
在企业敏感数据泄露事件中，绝大多数都是通过内部合法用户进行泄露的，对内部用户访问数据的数量、关系、序列进行多维度计算，形成用户行为正常行为基线，并检测出偏离正常基线的异常行为。
* 3.账号失陷检测
获取内部合法账户的权限，是大多数黑客攻击的目的，同时也是进一步渗透的主要手段，通过对内部账号的登陆地点、登陆时间、登陆次数、登陆设备、操作习惯等维度进行建模，对内部账号及相关实体进行实时分析，可以检测出哪些账号已经被攻破，哪些账号正面临着攻击。
* 4.绕过控制行为检测
很多恶意人员对于安全规则、内控措施非常了解，他们很清楚什么操作做到什么程度会触发报警。因此，恶意人员会降低非法操作行为的次数和规模，避免被传统安全系统检测到。利用用户实体行为分析（UEBA）长周期分析用户行为特征，将行为特征进行横向与纵向对比，检测长期低频有规律地重复性非法行为。
*5.在海量噪声中进行精准检测
很多传统设备虽然能够检测出用户行为异常，但由于存在着大量的误报和无效告警，使精准有效的检测结果淹没在了海量的噪声中，利用用户实体行为分析（UEBA）以分组聚合统计的方式，过滤安全告警相关的原始信息，有效降低安全事件分析工作量，提高传统设备告警的针对性和准确率。



## UEBA应用落地的关键事项
现今，很多人认为用户实体行为分析（UEBA）像防火墙、入侵检测一样，简单部署实施接入网络就可以发挥作用，一旦短时间内没有出现效果原有的期望就大打折扣，甚至悲观失望，这是目前非常普遍的态度。

用户实体行为分析（UEBA）属于数据驱动的高级安全分析技术，在企业具体的应用落地过程中，更像是一个解决方案具体应用而非一款单一具体产品。因此，在实施部署过程中，如果一些关键环节处理不好，应用落地效果就很差，甚至会导致项目失败。在用户实体行为分析（UEBA）应用落地过程中，应注意以下关键事项：

* 1.定义需要解决的风险场景，即**明确目标**
用户实体行为分析（UEBA）属于高级安全分析技术的一种，所以它是建立在基础安全控制的基础上的。如果各个单点安全建设还没有到位，基础安全控制还处在一穷二白的水平，那么实施用户实体行为分析（UEBA）的效果可能就会大打折扣。因此，用户实体行为分析（UEBA）成功应用的一个前提，是基础性安全建设已经比较成熟，最好是SIEM[<sup>2</sup>](#参考)或SOC平台已经建设完成，然后再集中力量解决某一个特定的安全风险场景。
<br/>
    作为网络安全领域的新兴技术，用户实体行为分析（UEBA）的定位和特长，是解决某个非常特定风险场景的手段。它不能解决一个非常大面的问题，比如分析一下三万个用户的行为习惯，这个需求就太泛泛了，没有形成特定的风险场景，不适合用用户实体行为分析（UEBA）来解决。因此，准备实施用户实体行为分析（UEBA）前，**首先应该考虑好到底来解决什么特定风险场景**，比如是解决电子银行撞库风险检测、还是解决利用合法账户盗取保单信息？**定义特定风险场景是实施用户实体行为分析（UEBA）的前提**，也只有将解决的风险场景定义清楚了，才能有针对性的开展后续的各项工作。
* 2.采集高质量多种类的数据
特定风险场景是前提，广泛的数据采集是用户实体行为分析（UEBA）应用落地的基础。如果输入的数据量比较少或者数据质量不高，用户实体行为分析（UEBA）最终分析出来的结果肯定是价值不高的，就算系统平台、模型算法再好，如果输入的是一堆垃圾数据，最终得出来的肯定还是一堆垃圾，这个道理很简单。
<br/>
    那么是不是数据越多越好呢？也不是，如果和需要要分析的风险场景无关，数据再多也只能是一种负担。所以数据采集的前提，就是要和需要分析的特定场景相匹配，也就是说想要分析这个特定场景需要什么数据，而不是有一堆数据看看能分析出什么结果。在这个前提下，**数据采集的要点是高质量和多种类**，用户实体行为分析（UEBA）对于数据的要求甚至超过了SIEM/SOC产品，除了一般的安全数据还包括广泛的IT信息，比如AD数据、IAM数据、业务应用数据等，除此之外还需要包括一些像资产、IP地址、组织架构、工作职责等上下文信息。总之，高质量多种类的数据，是用户实体行为分析（UEBA）成功条件之一。
* 3.专家驱动与机器学习算法
用户实体行为分析（UEBA）属于数据驱动的安全分析技术，很多人理所当然的认为机器学习算法是最核心的技术。不可否认用户实体行为分析（UEBA）在一定程度使用了机器学习，但并不等同于用户实体行为分析（UEBA）只用了（或者一定要用）机器学习，也不等同于采集了数据之后直接用机器学习算法分析就能达到想要的落地效果。

    实践表明，单纯的数据驱动并不能完成一个用户实体行为分析（UEBA）的完美应用，需要在数据驱动的基础上增加专家驱动形成一个双驱动的混合系统。这样一个混合系统，其异常发现就不是只是依赖于机器学习，而是依靠统计以及特征方法+机器学习算法来实现。而且，统计以及特征分析方法使用频率更高，将检测出的各个单点异常输入给机器学习来作为分析原料，在这些单点分析的基础上，利用机器学习算法的优势，快速确定不同的统计以及特征异常组合对应的风险水平，如果风险值大于一定范围就作为需要用户关注的事件进行输出。

    这种数据驱动+专家驱动的混合系统，在数据和机器学习之间有一个异常发现的过程及中间产物，利用专家领域的知识，简化了机器学习方面的工作，同时提升了系统灵活性，进而可以快速部署、快速完成学习过程。
* 4.与其它系统平台进行集成
目前用户实体行为分析（UEBA）存在两种产品形态，一种是原有SIEM厂商通过改造核心引擎来迎合高级分析、用户实体分析和风险评分；另外一种就是新兴厂商以独立的产品形态出现，单独用户实体行为分析（UEBA）产品就需要扩展平台功能或者与其它平台进行集成。

    Gartner认为单独的UEBA产品会越来越少，而会越来越成为一种高级安全分析功能存在于多种产品之中，所以UEBA与SIEM进行整合是大势所趋。笔者个人认为最好的模式是将UEBA的高级分析能力，整合到SIEM平台中，SIEM把数据送到UEBA，UEBA的告警和附带数据再反馈给SIEM，使SIEM成为真正意义上的下一代SIEM。

## UEBA的最佳实践以及相关厂商
UEBA 已经有一些成熟度比较高的产品：Exabeam、Gurucul、Interset、Niara、Securonix、Splunk（2015年收购Caspida）等[<sup>3</sup>](#参考)。

从这些产品看，希望为客户解决的问题是比较一致的，包括：
* 账号失陷检测
* 主机失陷检测
* 数据泄漏检测
* 内部用户滥用
* 提供事件调查的上下文
### UEBA和机器学习
UEBA 能被成功的部署、使用，有效的提升安全运营水平，其前提之一就是更广泛的数据收集，跨越传统的SIEM／SOC产品，UEBA产品在设计中就考虑了更多数据源，除了包括IT系统可能提供的EDR数据、AD数据以及业务应用数据，同时也包括了很多非IT的数据：ERP（相关企业？）、组织结构、工作职责、差旅等。有更多的数据，是其成功的条件之一。 
同样的UEBA厂商也看到了单纯的数据驱动不能完成一个完整的产品，如Exabeam ，就倡导并建立了一种数据驱动+专家驱动的混合系统，在Exabeam看来，单纯的数据驱动有下列的问题：

* 很难有一种情况，在学习之初就能得到需要的所有数据，每当有新的数据源都需要重新学习，这无疑是不可想象的工程灾难；
* 需要考虑随时增加新的features这个不可能避免的情况，这样情况下如何快速部署和开发？
* 最后，也是个人认为最重要的，机器学习得到的结果是黑盒，不能满足用户要求进行解释、说明的需求，这种情况下，最终用户可能难以进行事件的判别和响应工作。
因此它设计了一个更合理的技术架构，如下图所示（来源：Exabeam）：
![UEBA--EXabeam技术架构](https://secreed.github.io/assets/images/posts/2020-03/UEBA--EXabeam技术架构.png)
这样一个混合系统，其异常发现不是只依赖于机器学习，而是同时依靠统计以及特征的方法，一些通过机器学习可以输出明确结果的内容在这个阶段会也会体现出来，如DGA域名发现等；统计的方法会更经常出现，如某用户账号第一次访问一个文件夹、用户访问的文件数量异常等。但这些发现的异常不会产生直接给客户的报警，而是成为机器学习使用的原材料：features，在这些features基础上，再利用机器学习（包括贝叶斯方法），快速的确定不同features组合对应的风险值，而风险值大于一定范围才会成为需要用户关注的事件。这种方法，在数据和机器学习中间，有一个异常发现的过程及中间产物，利用专家领域的知识，简化了机器学习的方面的工作，同时提升了系统灵活性，进而可以快速部署、快速完成学习过程。

就举某用户账号第一次访问一个文件夹这种情况为例，它就需要同时去看其它features，来判定是否是高风险事件：这个用户所属的不同分类中（这里也应该隐藏了一部分机器学习），是否普遍存在这样的情况；这种访问新文件夹的概率在用户组织内是高概率事件等。

这样一种结合了专家知识、数据的力量和机器学习魔法的系统，才能够针对不同用户环境提供对应的风险发现能力，同时支持弹性、快速的用户部署。UEBA走到这步应该是一个较成熟的产品了，而机器学习在其中也有了成功的应用，不再是一个探索和尝试。

## 从整体企业安全谈UEBA
一直以来，网络安全领域里发现异常是一种很重要的能力。异常事件大多是一个小概率事件，同时要求非常精准，长期以来我们依赖于已知的规则来做检测，检测引擎里内置了无数个专家的规则和经验，但通过已知的规则，而规则阈值都是人定的，所以往往召回率会较低，准确率也有待提高。而UEBA是从另外一个视角去发现问题，我们从聚焦数据内容本身到内容上下文关系、行为分析等，从单点单条检测到多维度大数据分析来发现更多更准确的异常[<sup>4</sup>](#参考)。

![UEBA--企业安全谈UEBA](https://secreed.github.io/assets/images/posts/2020-03/UEBA--企业安全谈UEBA.png)
如果将整个企业安全划为四个层次（如上图），越往上的层次越靠近业务，可划分如下：
* 网络安全，聚焦于漏洞、APT事件、主机失陷等各类威胁；

* IT办公安全，包括员工信息泄露、违规操作、账号失陷等，现在还涉及到供应商安全；

* 业务安全，和企业业务强相关，比如在银行，业务安全基本上是做金融风控欺诈。业务安全分成外部、内部，外部有诈骗、盗号中木马，身份冒用账号设备等，内部主要涉及更深的业务问题，表现为职务犯罪(内鬼)、欺诈等。
### UEBA如何贯彻这几个层次
网络安全层面，因需要通晓不同领域的人才合作，UEBA需要运用机器学习技术的方法论应用一直比较难，大部分还属于尝试期。比如网络安全的人开始学习机器学习，而算法出身的人开始学习网络安全知识，那么内部最好的合作方式是建立虚拟团队，来协作共同完成发现IOC无法识别的失陷系统，比如未知木马后门家族的远控、内网攻击的横向移动、受控系统的数据泄漏等。

其余三层都跟业务很相关，比如什么样的是违规？什么样的是欺诈？总体上是基于行为分析来做风险控制。这种需要和企业懂业务的人建立虚拟团队，懂业务、懂数据算法等人来推行实践。 

**国内情况如下：**
1. 数据脏乱差，用户唯一标识、行为数据是否全面都不清楚，需要先做数据治理（UEBA从行为序列出发，所以对数据质量要求较高）

2. 环境恶劣，是否需要分析的数据都集中到了大数据平台，是否有足够的计算资源来做一些复杂的算法分析，（以为数据就在那，就可以随便分析了）

3. 业务方和需求方是否在一个项目组里，是否能快速顺利地沟通了解想法（往往梳理数据的时候，都需要问东问西，最后都不一定有结果）

4. 数据异常和业务异常的gap，关注数据异常？关注业务异常？数据异常不一定是业务异常，业务数据很多定义不清楚无法判断，有时候流程机制来验证评估优化都显得极度漫长。

很多人以为UEBA的难点是在于算法，其实并不是，这个方法已经很成熟了，难的是怎么应用到业务里，难的确定唯一用户标示、是否能拿到“好和相对全面”的数据等实际问题。但是现实更残酷的是往往环境和数据非常恶劣，这个时候往往连算法想施展的机会都不一定有，这个时候显得做“本地化数据分析”类的企业市场多么艰难。 

### 两个案例——用UEBA方法论实践去发现异常
通过建立用户画像、资产画像，一种是跟同组比较发现异常行为，比如发现违规查询某应用；第二种是跟历史比较，发现异常行为，比如账号被失陷，查询大量敏感信息。

![UEBA--案例1](https://secreed.github.io/assets/images/posts/2020-03/UEBA--案例1.png)
![UEBA--案例2](https://secreed.github.io/assets/images/posts/2020-03/UEBA--UEBA--案例2.png)

比如第一个图，我们通过提取用户行为，相似行为的人分成组，然后通过同组比较发现异常。

第二个图，根据某资产访问呈现周期性，经过历史模式比对，发现异常。

## UBA分析策略

### 分析策略
Gartner将UBA软件划分为两个大类：**依赖罐式分析规则标记异常行为的产品**、**基于动态规则或自定义模型分析的产品**[<sup>5</sup>](#参考)。
在罐式规则的产品中，管理员可能会定义，如果一个敏感文件在周末的凌晨0点到5点被访问则强制弹出一个告警；而在纯动态规则的场景下，潜层的UBA引擎会决定什么样的行为是正常的，并且检测到落到正常范围之外的活动，换句话说，UBA引擎在构建他自己的内部规则。

在UBA产品中，上述两种策略都占有一席之地。但单纯依靠罐式规则分析的UBA软件还需要一支对黑客行为有着强大直觉的IT全安管理员队伍，然而没有多少IT安全人员有这种巫师一样的能力；UBA软件的另一个差别在于对潜层数据源头的选择，有些UBA解决方案主要关注网络连接和边界系统的行为（登录、app、事件），另一些UBA则是更关注内部系统中颗粒更细的活动，比如用户在文件和邮件上的操作。

纯粹利用网络连接或者基于系统日志的分析方法有很多缺点，如上文所说，它很难发现那些利用邮件或者注入的方式盗取正常账号进行入侵的行为，除非你有更高级的智能UBA，因为在这种情况下黑客登录或者使用APP的行为不会与普通用户有任何不同。

而那些关注用户在文件和邮件操作行为的UBA软件则会有更高的几率发现攻击者，关键点在于，想要伪装成正常用户的黑客一定会尝试搜索和拷贝带有敏感信息的文件，而这正是抓住他们的关键。

### 如何判断正常行为
UBA是基于这样一个想法提出来的，即系统上的用户到底在做什么？他们的活动和访问文件的模式是什么样的。最终，UBA软件起源于一个profile，用来描述每个行为对于一个用户的意义，所以当黑客偷了一个用户的凭证并且访问了他几乎从不访问的资源时，他的行为就会与之前的profile有所不同。为了实现上述想法，UBA就必须可以记录用户的行为，并量化检测到的用户行为。UBA软件必须可以通过训练来定义出用户的正常行为，通常来讲需要考虑一段时间内用户的活动日志，比如文件访问、登录、网络连接等。

UBA可以使用通用的基于大数据的挖掘算法，如KNN、线性回归、贝叶斯等，但是不管你用的哪种具体算法，目的都是要建立一个行为基线，从而可以预测什么是正常什么是异常。

## 机器学习算法在用户行为检测(UBA)领域的应用
&nbsp;&nbsp;&nbsp;&nbsp;正如Gartner报告所述，最具创新能力的UBA供应商往往都是一些初创公司，我们比较了IBM、HPE、Splunk这类大公司的UBA产品，但是感觉无非就是SIEM产品的更新升级罢了，相反一些名不见经传的初创公司如Balabit、Sqrrl等的UBA产品到让人眼前一亮。在参考业界的同时，我们也在UBA的核心算法上做了一番研究，要知道UBA之所以号称下一代SIEM，其核心就是将机器学习引入行为数据检测，本文简要总结一下近期研究的适用于UBA的机器学习算法和效果[<sup>6</sup>](#参考).

&nbsp;&nbsp;&nbsp;&nbsp;UBA产品并不依赖某个“银弹”算法，其必定是一系列机器学习算法的有机融合，稍微了解机器学习的同学都清楚，像贝叶斯家族、线性回归这类有监督学习算法往往都需要大量的训练样本，但是网络安全领域APT攻击的样本一年抓不住两个，要说大量训练几乎没可能，因此UBA产品大量采用非监督学习算法，通过聚合行为数据巧妙的达到异常检测的目的。下面简要介绍一下在行为检测过程中常用的机器学习算法。

&nbsp;&nbsp;&nbsp;&nbsp;首先我们假设一个用户场景，张三，是一个SO的系统管理员，他的账号有很多出入IT系统的权限，某天他的账号被黑客盗用了，黑客通过VPN等通道接入内网，并且将数据偷盗到公司外出售给竞争对手。

&nbsp;&nbsp;&nbsp;&nbsp;一个低风险用户的正常业务活动通常没什么可关注的，但是一些高风险人群的正常活动或者低风险账号进行的高危操作则足以值得调查人员关注，更近一步，如果一个高风险用户做了一些高危并且不长出现的动作，那就绝对需要安全人员介入调查了。这里有一个问题，**我们如何知道一个用户风险等级是高还是低？**这便是UBA及其算法要解决的核心问题，**通过建立动态行为基线发现用户偏离正常模式的行为，并根据风险累计的数值判断用户风险级别**。综上，构建用户的特征行为矩阵是第一步，也即User-Profile，特征行为矩阵的构建方法五花八门，考虑到HBase支持数据量大，列式存储等特点，我们选择将特征矩阵保存在HBase里。

&nbsp;&nbsp;&nbsp;&nbsp;张三，像其他特权用户一样，利用其账号的权限登录到某一台主机或者服务器，主机登录算法用以检测每个用户经常使用的主机或者服务，DBA通常倾向于登录固定的几台机器，并且都是使用相似的命令，同时销售人员都是使用天兔或者某个XX系统的服务，两者使用方式完全不同。这里张三登录的是一台保存销售数据的服务器，而显然，这与他之前的模式或者与他所在的Peer-Group都是格格不入的。这里我们**使用KMeans算法根据用户行为数据的特征矩阵对用户划分Peer-Group，行为模式类似的人群会划分到一个动态群组**。

&nbsp;&nbsp;&nbsp;&nbsp;除了动态群组，**根据现有的系统权限组进行风险评估**同样是一种有效方式，我们从LDAP或者AD获取用户组以及组的成员数，通常规模较小的组比成千上万用户的组风险系数更高。当张三的账号被黑客从普通管理员组提升到超级管理员组的时候，他的账号瞬间进入了一个人烟罕至的群组，这时候他的风险值会瞬间提升。

&nbsp;&nbsp;&nbsp;&nbsp;除了用户登录的机器，登录时间也是行为特征中非常重要的一个环节，基于时间序列的分析方法有很多，这里我们**使用KDE(核心概率密度估计)算法来统计和预测用户在某个时间段登录的概率**，这种方法可以有效的克服离散数据在模式匹配过程中容易过耦合的问题。比如张三作为一个系统管理员，通常的登录时间是上班时间以及晚饭以后的时间，早上7:30属于正常登录时间，而凌晨0点登录就会被标记为高度反常和可疑。

&nbsp;&nbsp;&nbsp;&nbsp;张三登录系统以后进行了一系列的操作，通常一个用户在一段时间内能够产生的操作个数也是一个人的典型特征，User-Profile聚合一个用户在一段时间内产生的所有行为数据的数量，使用KDE重新组织统计数据，并检测这个模式是否发生明显改变。如果这里张三在一小时内接连登录了30+台服务器，而他通常也就登录2、3台，那么这里就与正常的行为有明显的偏移。

&nbsp;&nbsp;&nbsp;&nbsp;基于频繁项集的聚类算法(如Aprior/FP-Growth)在零售行业很早以前就有广泛应用，比如沃尔玛对顾客购买商品的模式发掘发现啤酒和尿布经常一起出售。基于频繁项集的机器学习算法在UBA领域也有广泛应用，比如，张三通常在周末的时候通过SSH协议登录，而在工作日通过RDP协议登录，那么有一天他在周末通过RDP登录就是一个行为模式的偏移。

&nbsp;&nbsp;&nbsp;&nbsp;主成分分析(PCA) 是一种应用广泛的降维算法，其在行为数据异常检测的过程中有很好的效果，首先用户行为的特征矩阵往往都有成千上万个维度，如果我们想从海量数据的特征矩阵中找出异常也即离群的点，计算难度会比较大，我们采用PCA对特征进行降维并结合KMeans等聚类算法找出离群点。比如，张三通常会长时间使用前台的服务器，而运维后台服务器的时候比较短，如果他长时间停留在后台服务器上我们的算法会将其潜在的风险值提高。

&nbsp;&nbsp;&nbsp;&nbsp;上面介绍的几个算法Spark的MLlib提供的全部的实现，不得不感叹一下Spark确实是解放程序猿双手的良心之作。再往后，基于图数据的分析挖掘是我们后续的研究方向，安全调查人员时常需要看到用户和实体之间的数据关联，或者所谓的Kill-Chain，图数据库和基于Graph的算法天然支持这一点，好在Spark GraphX又替我们做到了这一步。图数据的挖掘我想业界应该没有比Palantir做的更好的了，就是那个号称帮助美军找到本·拉登的那家传奇数据公司


## 总结
利用数据分析、机器学习等手段，对特定安全风险进行持续监控、分析，识别各种已知和未知的安全威胁和用户行为异常，使企业能够更好地检测和应对不断变化的内外部威胁，这就是用户实体行为分析（UEBA）的使命。


## 参考

[1] [UEBA如何在企业有效地应用与落地](https://www.sec-un.org/ueba%E5%A6%82%E4%BD%95%E5%9C%A8%E4%BC%81%E4%B8%9A%E6%9C%89%E6%95%88%E5%9C%B0%E5%BA%94%E7%94%A8%E4%B8%8E%E8%90%BD%E5%9C%B0/)

[2] [什么是SIEM软件](https://baijiahao.baidu.com/s?id=1627672368416983120&wfr=spider&for=pc)

[3] [浅析用户行为分析系统（UEBA）](https://www.freebuf.com/articles/neopoints/131514.html)

[4] [UEBA在企业安全领域应用的现状和挑战](https://www.secrss.com/articles/760)

[5] [新一代数据安全的制胜法宝-UBA](https://www.jianshu.com/p/b7eda54bb1e5)

[6] [机器学习算法在用户行为检测(UBA)领域的应用](http://dearcharles.cn/2017/11/11/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AE%97%E6%B3%95%E5%9C%A8%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%A3%80%E6%B5%8B-UBA-%E9%A2%86%E5%9F%9F%E7%9A%84%E5%BA%94%E7%94%A8/)

[7] [【真实案例】用户行为分析如何破解保单信息泄露检测与防护难题](https://mp.weixin.qq.com/s/JzuqmCGbYd7apl4B9xtXUg)